name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Install Bazelisk
      run: brew install bazelisk

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-${{ runner.os }}-${{ hashFiles('third_party/googlesql/MODULE.bazel') }}
        restore-keys: |
          bazel-${{ runner.os }}-

    - name: Build static library
      run: make lib

    - name: Build release binary
      run: CGO_ENABLED=1 go build -ldflags "-X main.version=${{ github.ref_name }}" -o go-bigq ./cmd/bigq/

    - name: Verify binary
      run: |
        ./go-bigq version
        file go-bigq

    - name: Create archive
      run: tar -czvf go-bigq-${{ github.ref_name }}-arm64.tar.gz go-bigq

    - name: Generate SHA256
      run: shasum -a 256 go-bigq-${{ github.ref_name }}-arm64.tar.gz > go-bigq-${{ github.ref_name }}-arm64.tar.gz.sha256

    - name: Generate release notes
      run: |
        PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
        if [ -z "$PREV_TAG" ]; then
          NOTES=$(git log --pretty=format:"- %s" HEAD)
        else
          NOTES=$(git log --pretty=format:"- %s" ${PREV_TAG}..HEAD)
        fi
        echo "$NOTES" > release_notes.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          go-bigq-${{ github.ref_name }}-arm64.tar.gz
          go-bigq-${{ github.ref_name }}-arm64.tar.gz.sha256
        body_path: release_notes.txt
